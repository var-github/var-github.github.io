<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Projects</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Fonts & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="style.css" />
</head>
<body>
    <div id="loading-overlay" style="display:none;">
        <div class="spinner"></div>
    </div>
    <div id="timer-display" style="display:none; position:fixed; top:10px; right:10px; background:#333; color:#fff; padding:5px 10px; border-radius:4px; font-family:sans-serif; z-index:10000;"></div>
    <nav>
        <button class="active" onclick="show('projects',this)">Projects</button>
        <button onclick="show('aboutme',this)">About Me</button>
    </nav>
    <h1 id="main-title">Projects</h1>
    <section id="projects">
        <aside tabindex="0">
            <span class="material-symbols-outlined panel-icon">auto_awesome_mosaic</span>
            <div class="panel-title">Choose Project</div>
            <ul id="project-list"></ul>
            <!-- We need to create <li> tags using js
                <li><button class="active" onclick="changeProject(0,this)">Sudoku Solver</button></li>
                <li><button onclick="changeProject(1,this)">Chatbot</button></li>
                <li><button onclick="changeProject(2,this)">Translator</button></li>
            -->
        </aside>
        <main id="iframe-container">
            <button id="prev-project" class="nav-button" title="Previous Project">
                <span class="material-symbols-outlined">arrow_cool_down</span>
            </button>
            <button id="next-project" class="nav-button" title="Next Project">
                <span class="material-symbols-outlined">arrow_cool_down</span>
            </button>
        </main>
    </section>
    <section id="aboutme" style="display:none;">
        <main>
            <div class="card-content">
                <b>About Me</b><br>
                This is the About Me section. Add your content here. You can include more details, images, or anything you wish, and it will have plenty of space!
            </div>
        </main>
    </section>
    <script>
        function createProjectElements() {
            // Show loading symbol
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';

            // Get timer display element
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.style.display = 'none';
        
            let timerInterval;
            let countdown = 60;
        
            function startCountdown() {
                timerDisplay.style.display = 'block';
                timerDisplay.textContent = `Timer: ${countdown}s`;
                timerInterval = setInterval(() => {
                    countdown--;
                    timerDisplay.textContent = `Timer: ${countdown}s`;
                    if (countdown <= 0) {
                        clearInterval(timerInterval);
                    }
                }, 1000);
            }
        
            function stopCountdown() {
                clearInterval(timerInterval);
                countdown = 60;
                timerDisplay.style.display = 'none';
            }

            // Get projects to display
            fetch('https://api.github.com/repos/var-github/var-github.github.io/contents/projects_to_display.json')
            .then(res => res.json())
            .then(data => {
                // atob - decodes base64 to string
                const json = JSON.parse(atob(data.content));
                /*This is the format of json
                {
                      "Sudoku Solver" : "LINK",
                      "Chatbot" : "LINK",
                      "Translator" : "LINK"
                }*/
                // Takes every key, value pair and converts to { name: "Sudoku Solver", url: "LINK" } form
                const projects = Object.entries(json).map(([name, url]) => ({name: name, url: url + "?embed=true"}));
                /* Final format
                [
                      { name: "Sudoku Solver", url: "LINK" },
                      { name: "Chatbot", url: "LINK" },
                      { name: "Translator", url: "LINK" }
                ]*/
                
                // Call API to initiate workflow (this workflow keeps the streamlit apps up)
                fetch('https://var-github-projects.vercel.app/api/call_workflow')
                  .finally(() => {
                    clearTimeout(delayTimer);
                    stopCountdown();
                    
                    const list = document.getElementById('project-list');
                    const iframeContainer = document.getElementById('iframe-container');
                    list.innerHTML = '';

                    projects.forEach(({name, url}, index) => {
                        // Add sidebar buttons
                        const li = document.createElement('li');
                        const btn = document.createElement('button');
                        btn.textContent = name;
                        btn.onclick = function() { changeProject(index, btn); };
                        if (index === 0) btn.classList.add('active');
                        li.appendChild(btn);
                        list.appendChild(li);

                        // Create iframe
                        const iframe = document.createElement('iframe');
                        iframe.src = url;
                        if (index === 0) iframe.classList.add('active');
                        iframeContainer.appendChild(iframe);
                    });

                    // Wait 3 secs for iframe to load
                    (async () => {
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        // Hide loading symbol
                        loadingOverlay.style.display = 'none';
                    })();
                });
                
                // Set a 5-second delay timer for showing countdown
                const delayTimer = setTimeout(() => {
                  startCountdown();
                }, 3500);
            });
        }

        document.addEventListener('DOMContentLoaded', createProjectElements);
        
        // Tab switching
        function show(id, btn) {
            // Using ternary operator - (condition ? expressionIfTrue : expressionIfFalse;)
            // Setting display to '' (default) or 'none'
            document.getElementById('projects').style.display = (id == 'projects' ? '' : 'none');
            document.getElementById('aboutme').style.display = (id == 'aboutme' ? '' : 'none');
            // Setting tab title
            document.getElementById('main-title').textContent = btn.textContent;
            // Remove active class from all buttons
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            // Add active class to this button
            btn.classList.add('active');
        }
        // Project switching
        function changeProject(idx, btn) {
            // .forEach((f, i) => ...) loops over each iframe element f with its index i
            // .toggle("class to toggle", true/false)
            //  If i == idx is true, the class 'active' is added
            //  If i == idx is false, the class 'active' is removed
            document.querySelectorAll('iframe').forEach((f, i) => f.classList.toggle('active', i == idx));
            document.querySelectorAll('ul button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        // Project navigation
        document.getElementById('prev-project').onclick = function(e){
            let iframes = document.querySelectorAll('iframe'), idx = [...iframes].findIndex(f=>f.classList.contains('active'));
            document.querySelectorAll('ul button')[(idx+iframes.length-1)%iframes.length].click();
        };
        document.getElementById('next-project').onclick = function(e){
            let iframes = document.querySelectorAll('iframe'), idx = [...iframes].findIndex(f=>f.classList.contains('active'));
            document.querySelectorAll('ul button')[(idx+1)%iframes.length].click();
        };
    </script>
</body>
</html>
